# Assistants Playground

Небольшая панель управления для Assistants API на FastAPI. Помимо веб-интерфейса можно обращаться к API напрямую.

## Запуск

1. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```
   Помимо FastAPI и OpenAI клиентской библиотеки понадобится Jinja2 для шаблонов,
   `werkzeug` для хэширования паролей и `python-multipart` для обработки форм.

2. Создайте файл `.env` со своим ключом API:
   ```bash
   OPENAI_API_KEY=ваш_ключ
   SESSION_SECRET_KEY=секрет_для_сессий
   DB_PATH=app.db
   ```

Приложение использует возможности Assistants API v2, поэтому все запросы выполняются
с заголовком `OpenAI-Beta: assistants=v2` (это уже настроено в коде).
Файлы ассистента добавляются через обновление его `tool_resources`, так как в
версии API v2 больше нет отдельного ресурса `assistant.files`.

3. Запустите приложение:
   ```bash
   uvicorn app:app --reload
   ```

После запуска откройте в браузере `http://localhost:8000`.
Вы увидите стартовую страницу с кнопками входа и регистрации (надпись
"OpenAi hub api v2.0"). При первом запуске зарегистрируйтесь и войдите в систему. Пароли хранятся в базе
данных SQLite (`DB_PATH`), поэтому файл можно перенести в безопасное место.
Главная страница теперь представляет собой дашборд: выводится текущий баланс
аккаунта, суммарные затраты за последние 30 дней и таблица ежедневных расходов.
Баланс рассчитывается по данным из эндпоинта `/billing/subscription` и учёту
расходов. Если OpenAI не отдаёт эти сведения (например, при бесплатном тарифе),
поля будут нулевыми. При ошибке запроса интерфейс покажет уведомление.
В разделе "Управление ассистентами" можно создавать и удалять ассистентов,
а также выбирать модель, температуру и top p при создании.
Все разделы доступны только после входа в систему; регистрация и авторизация
осуществляются через простые формы.
Добавлен отдельный раздел «File Search» для создания хранилищ файлов (vector stores).
Их можно привязывать к ассистентам при создании.
Списки ассистентов и File Search поддерживают поиск и пагинацию.
При создании ассистента по умолчанию используются параметры:
- модель `gpt-4o-mini`;
- температура `0.30`;
- top p `0.15`.
Эти значения можно изменить при создании через форму.
На странице списка ассистентов есть кнопка «Тестировать», позволяющая вести
диалог с выбранным ассистентом. В процессе создаётся отдельный thread, который
можно очистить кнопкой «Очистить диалог».

Ошибки выводятся всплывающими уведомлениями (Bootstrap toast) и одновременно
записываются в логи приложения, что помогает отслеживать проблемы.
В пункте меню «Настройка сайта» можно сменить свой пароль и
при необходимости закрыть регистрацию для новых пользователей.

## API

Помимо веб-интерфейса можно обращаться к приложению программно. Все
эндпоинты начинаются с префикса `/bot`, как и в Telegram‑боте.
Доступные маршруты:

- `GET /bot/assistants` — список ассистентов.
- `GET /bot/assistants/{id}` — получить данные одного ассистента.
- `POST /bot/assistants` — создать ассистента.
- `PUT /bot/assistants/{id}` — обновить ассистента.
- `DELETE /bot/assistants/{id}` — удалить ассистента.
- `POST /bot/assistants/{id}/files` — прикрепить файл к ассистенту.
- `DELETE /bot/assistants/{id}/files/{file_id}` — удалить файл.
- `GET /bot/vector_stores` — список File Search хранилищ.
- `POST /bot/vector_stores` — создать хранилище.
- `GET /bot/vector_stores/{id}` — получить одно хранилище.
- `DELETE /bot/vector_stores/{id}` — удалить хранилище.
- `GET /bot/vector_stores/{id}/files` — список файлов хранилища.
- `POST /bot/vector_stores/{id}/files` — добавить файл в хранилище.
- `DELETE /bot/vector_stores/{id}/files/{file_id}` — удалить файл из хранилища.
- `GET /bot/models` — список доступных GPT‑моделей.
- `POST /bot/create_thread` — создать новый thread, возвращает `thread_id`.
- `GET /bot/threads/{id}` — получить данные треда.
- `DELETE /bot/threads/{id}` — удалить тред.
- `POST /bot/threads/{id}/messages` — добавить сообщение пользователя.
- `GET /bot/threads/{id}/messages` — получить сообщения треда.
- `POST /bot/run` — запустить ассистента в треде. Требуются поля
  `thread_id` и `assistant_id`.
- `GET /bot/thread_status/{run_id}` — статус запущенного треда. В
  параметре `thread_id` передаётся идентификатор треда.
- `POST /bot/threads/{id}/runs/{run_id}/cancel` — отменить выполнение.
- `POST /bot/assistants/{id}/chat` — задать вопрос ассистенту в новом треде.
- `GET /bot/billing` — данные баланса и расходов.
- `POST /bot/register` — регистрация пользователя (если разрешена).
- `POST /bot/login` — вход в систему.
- `POST /bot/logout` — выход из системы.
- `GET /bot/settings` — текущие настройки сайта.
- `PUT /bot/settings` — обновить настройку регистрации.
- `PUT /bot/password` — сменить пароль текущего пользователя.
