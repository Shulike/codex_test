# Assistants Playground

Небольшая панель управления для Assistants API на FastAPI. Помимо веб-интерфейса можно обращаться к API напрямую.

## Запуск

1. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```
   Помимо FastAPI и OpenAI клиентской библиотеки понадобится Jinja2 для шаблонов,
   `werkzeug` для хэширования паролей и `python-multipart` для обработки форм.

2. Создайте файл `.env` со своим ключом API:
   ```bash
   OPENAI_API_KEY=ваш_ключ
   SESSION_SECRET_KEY=секрет_для_сессий
   DB_PATH=app.db
   ```

Приложение использует возможности Assistants API v2, поэтому все запросы выполняются
с заголовком `OpenAI-Beta: assistants=v2` (это уже настроено в коде).
Файлы ассистента добавляются через обновление его `tool_resources`, так как в
версии API v2 больше нет отдельного ресурса `assistant.files`.

3. Запустите приложение:
   ```bash
   uvicorn app:app --reload
   ```

После запуска откройте в браузере `http://localhost:8000`.
Вы увидите стартовую страницу с кнопками входа и регистрации (надпись
"OpenAi hub api v2.0"). При первом запуске зарегистрируйтесь и войдите в систему. Пароли хранятся в базе
данных SQLite (`DB_PATH`), поэтому файл можно перенести в безопасное место.
Главная страница теперь представляет собой дашборд: выводится текущий баланс
аккаунта, суммарные затраты за последние 30 дней и таблица ежедневных расходов.
Баланс рассчитывается по данным из эндпоинта `/billing/subscription` и учёту
расходов. Если OpenAI не отдаёт эти сведения (например, при бесплатном тарифе),
поля будут нулевыми. При ошибке запроса интерфейс покажет уведомление.
В разделе "Управление ассистентами" можно создавать и удалять ассистентов,
а также выбирать модель, температуру и top p при создании.
Все разделы доступны только после входа в систему; регистрация и авторизация
осуществляются через простые формы.
Добавлен отдельный раздел «File Search» для создания хранилищ файлов (vector stores).
Их можно привязывать к ассистентам при создании.
Списки ассистентов и File Search поддерживают поиск и пагинацию.
При создании ассистента по умолчанию используются параметры:
- модель `gpt-4o-mini`;
- температура `0.30`;
- top p `0.15`.
Эти значения можно изменить при создании через форму.
На странице списка ассистентов есть кнопка «Тестировать», позволяющая вести
диалог с выбранным ассистентом. В процессе создаётся отдельный thread, который
можно очистить кнопкой «Очистить диалог».

Ошибки выводятся всплывающими уведомлениями (Bootstrap toast) и одновременно
записываются в логи приложения, что помогает отслеживать проблемы.
В пункте меню «Настройка сайта» можно сменить свой пароль и
при необходимости закрыть регистрацию для новых пользователей.

## API

Помимо веб-интерфейса можно обращаться к приложению программно. Все
эндпоинты начинаются с префикса `/api`. Для совместимости также
поддерживается префикс `/bot`. POST-запросы принимают данные в виде
`application/json`, а формы (`application/x-www-form-urlencoded`) остаются
для обратной совместимости и считаются устаревшими.
Доступные маршруты:

- `GET /api/assistants` — список ассистентов.
- `GET /api/assistants/{id}` — получить данные одного ассистента.
- `POST /api/assistants` — создать ассистента.
- `PUT /api/assistants/{id}` — обновить ассистента.
- `DELETE /api/assistants/{id}` — удалить ассистента.
- `POST /api/assistants/{id}/files` — прикрепить файл к ассистенту.
- `DELETE /api/assistants/{id}/files/{file_id}` — удалить файл.
- `GET /api/vector_stores` — список File Search хранилищ.
- `POST /api/vector_stores` — создать хранилище.
- `GET /api/vector_stores/{id}` — получить одно хранилище.
- `DELETE /api/vector_stores/{id}` — удалить хранилище.
- `GET /api/vector_stores/{id}/files` — список файлов хранилища.
- `POST /api/vector_stores/{id}/files` — добавить файл в хранилище.
- `DELETE /api/vector_stores/{id}/files/{file_id}` — удалить файл из хранилища.
- `GET /api/models` — список доступных GPT‑моделей.
 - `POST /api/create_thread` — создать thread (`{"initial_message":"..."}` опционально), возвращает `thread_id`.
- `GET /api/threads/{id}` — получить данные треда.
- `DELETE /api/threads/{id}` — удалить тред.
- `POST /api/threads/{id}/messages` — добавить сообщение (`{"role": "user", "content": "..."}`).
- `GET /api/threads/{id}/messages` — получить сообщения треда.
- `POST /api/run` — запустить ассистента (`{"thread_id":"...","assistant_id":"..."}`).
- `GET /api/thread_status/{run_id}` — статус выполнения, параметр `thread_id` передаётся через query.
- `POST /api/cancel_run/{run_id}` — отменить выполнение (`{"thread_id":"..."}`).
- `POST /api/threads/{id}/runs/{run_id}/cancel` — устаревший маршрут отмены.
- `GET /api/latest_message/{thread_id}` — последняя реплика треда.
- `GET /api/file_metadata/{file_id}` — имя файла.
- `POST /api/assistants/{id}/chat` — задать вопрос ассистенту в новом треде.
- `GET /api/billing` — данные баланса и расходов.
- `POST /api/register` — регистрация пользователя (если разрешена).
- `POST /api/login` — вход в систему.
- `POST /api/logout` — выход из системы.
- `GET /api/settings` — текущие настройки сайта.
- `PUT /api/settings` — обновить настройку регистрации.
- `PUT /api/password` — сменить пароль текущего пользователя.
